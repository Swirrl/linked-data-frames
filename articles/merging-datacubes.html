<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merging DataCubes • ldf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Merging DataCubes">
<meta property="og:description" content="ldf">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ldf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Linked data frames</li>
    <li>
      <a href="../articles/introduction-to-ldf.html">Introduction to LDF</a>
    </li>
    <li>
      <a href="../articles/creating-ldf-resources.html">Creating LDF Resources</a>
    </li>
    <li>
      <a href="../articles/working-with-ldf-intervals.html">Working with LDF Intervals</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Data cubes</li>
    <li>
      <a href="../articles/mapping-statistical-geography.html">Mapping Statistical Geography</a>
    </li>
    <li>
      <a href="../articles/tabulate-datacube.html">Tabulating DataCubes</a>
    </li>
    <li>
      <a href="../articles/merging-datacubes.html">Merging DataCubes</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Swirrl/linked-data-frames/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="merging-datacubes_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="merging-datacubes_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="merging-datacubes_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Merging DataCubes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Swirrl/linked-data-frames/blob/master/vignettes/merging-datacubes.Rmd"><code>vignettes/merging-datacubes.Rmd</code></a></small>
      <div class="hidden name"><code>merging-datacubes.Rmd</code></div>

    </div>

    
    
<p>This tutorial demonstrates how to merge data cubes using linked data frames.</p>
<p>For brevity the code used to construct the input cubes is hidden. You can read the details in the <a href="https://github.com/Swirrl/linked-data-frames/blob/master/vignettes/merging-datacubes.Rmd">source code for this vignette on github</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://swirrl.github.io/linked-data-frames">ldf</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://yihui.org/knitr">knitr</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://magrittr.tidyverse.org">magrittr</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org">dplyr</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://vctrs.r-lib.org">vctrs</a></span>)
</pre></div>
<p>There are a several ways to combine data cubes:</p>
<ul>
<li>concatenating rows to gather observations from different cubes into a single collection</li>
<li>using correspondence lookups to translate dimension values from one codelist into another</li>
<li>joining cubes by dimension and code URIs to add more rows or columns as required</li>
</ul>
<p>We’ll explore each in turn.</p>
<div id="concatenating-rows-of-observations" class="section level1">
<h1 class="hasAnchor">
<a href="#concatenating-rows-of-observations" class="anchor"></a>Concatenating rows of observations</h1>
<p>You can concatenate observations by “row binding” tables - adding rows from one table onto the end of another making a single, longer table.</p>
<p>This is simple if the cubes have the same components. This basically means that tables need to have the same set of columns.</p>
<div id="rows-with-matching-columns" class="section level2">
<h2 class="hasAnchor">
<a href="#rows-with-matching-columns" class="anchor"></a>Rows with matching columns</h2>
<p>The following two excerpts from population datasets on <a href="http://linked.nisra.gov.uk">linked.nisra.gov.uk</a> have the same structure.</p>
<p>One is for Local Government Districts:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">pop_by_lgd</span>)
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">area</th>
<th align="left">gender</th>
<th align="left">age</th>
<th align="right">population</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">0</td>
<td align="right">1629</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">1</td>
<td align="right">1672</td>
</tr>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">2</td>
<td align="right">1710</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">3</td>
<td align="right">1861</td>
</tr>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">4</td>
<td align="right">1816</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">5</td>
<td align="right">1845</td>
</tr>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">6</td>
<td align="right">1907</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">7</td>
<td align="right">2006</td>
</tr>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">8</td>
<td align="right">1988</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">9</td>
<td align="right">2004</td>
</tr>
</tbody>
</table>
<p>The other for Parliamentary Constituencies:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">pop_by_pc</span>)
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">area</th>
<th align="left">gender</th>
<th align="left">age</th>
<th align="right">population</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">0</td>
<td align="right">1141</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">1</td>
<td align="right">1163</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">2</td>
<td align="right">1170</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">3</td>
<td align="right">1159</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">4</td>
<td align="right">1150</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">5</td>
<td align="right">1205</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">6</td>
<td align="right">1135</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">7</td>
<td align="right">1186</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">8</td>
<td align="right">1233</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">9</td>
<td align="right">1153</td>
</tr>
</tbody>
</table>
<p>These cubes are essentially the same, it’s just the there are different types of geography in the <code>area</code> column. Because the URIs for the two geography types can’t overlap (they’re <em>Unique</em> Resource Identifiers after all), we can concatenate the rows into a single table.</p>
<p>We need to use <code><a href="https://vctrs.r-lib.org/reference/vec_bind.html">vctrs::vec_rbind()</a></code> instead of <code><a href="https://rdrr.io/r/base/cbind.html">base::rbind()</a></code> because this makes sure the resource descriptions are merged:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_bind.html">vec_rbind</a></span>(<span class="kw">pop_by_lgd</span>, <span class="kw">pop_by_pc</span>) <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">area</th>
<th align="left">gender</th>
<th align="left">age</th>
<th align="right">population</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">0</td>
<td align="right">1629</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">1</td>
<td align="right">1672</td>
</tr>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">2</td>
<td align="right">1710</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">3</td>
<td align="right">1861</td>
</tr>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">4</td>
<td align="right">1816</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">5</td>
<td align="right">1845</td>
</tr>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">6</td>
<td align="right">1907</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">7</td>
<td align="right">2006</td>
</tr>
<tr class="odd">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">8</td>
<td align="right">1988</td>
</tr>
<tr class="even">
<td align="left">N09000001</td>
<td align="left">All Persons</td>
<td align="left">9</td>
<td align="right">2004</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">0</td>
<td align="right">1141</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">1</td>
<td align="right">1163</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">2</td>
<td align="right">1170</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">3</td>
<td align="right">1159</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">4</td>
<td align="right">1150</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">5</td>
<td align="right">1205</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">6</td>
<td align="right">1135</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">7</td>
<td align="right">1186</td>
</tr>
<tr class="odd">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">8</td>
<td align="right">1233</td>
</tr>
<tr class="even">
<td align="left">N06000001</td>
<td align="left">All Persons</td>
<td align="left">9</td>
<td align="right">1153</td>
</tr>
</tbody>
</table>
</div>
<div id="rows-with-different-columns" class="section level2">
<h2 class="hasAnchor">
<a href="#rows-with-different-columns" class="anchor"></a>Rows with different columns</h2>
<p>If the cubes have different structures we will need to alter the tables of observations so that they have the same columns. We can remove spare columns if we first filter the rows such that there’s only a single value for that column. We can add missing columns by filling in values with a default.</p>
<p>These two excerpts from the <a href="https://www.gov.uk/government/statistical-data-sets/journey-time-statistics-data-tables-jts">Journey times to key services</a> datasets demonstrate the problem.</p>
<p>These are the journey times from each neighbourhood to the town centre:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">jt_town</span>)
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">area</th>
<th align="left">mode</th>
<th align="left">date</th>
<th align="right">travel_time</th>
<th align="left">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">22.72201</td>
<td align="left">Minutes</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">13.94595</td>
<td align="left">Minutes</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">14.58818</td>
<td align="left">Minutes</td>
</tr>
</tbody>
</table>
<p>The employment centres table by contrast has one extra column: <code>employment_centre_size</code>. This breakdown wasn’t applicable to town centres but it’s important to distinguish employment centres.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">jt_employment</span>)
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">area</th>
<th align="left">employment_centre_size</th>
<th align="left">mode</th>
<th align="left">date</th>
<th align="right">travel_time</th>
<th align="left">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Employment centre with 100 to 499 jobs</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">20</td>
<td align="left">Minutes</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Employment centre with 100 to 499 jobs</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">12</td>
<td align="left">Minutes</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Employment centre with 100 to 499 jobs</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">13</td>
<td align="left">Minutes</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Employment centre with 500 to 4999 jobs</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">4</td>
<td align="left">Minutes</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Employment centre with 500 to 4999 jobs</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">7</td>
<td align="left">Minutes</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Employment centre with 500 to 4999 jobs</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">7</td>
<td align="left">Minutes</td>
</tr>
</tbody>
</table>
<p>We could choose to ignore it, picking a single value from the breakdown. In some cases the codelist will be hierarchical, having e.g. a value for “Any” or “Total” at the top of the tree. This effectively ignores the breakdown <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. In this case that’s not possible so we’ll have to pick an employment centre size.</p>
<p>Let’s take moderately-sized employment centres. Once we’ve filtered to those rows, we can remove the redundant column:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">jt_employment_500</span> <span class="op">&lt;-</span> 
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">jt_employment</span>,
          <span class="fu"><a href="../reference/label.html">label</a></span>(<span class="kw">employment_centre_size</span>)<span class="op">==</span><span class="st">"Employment centre with 500 to 4999 jobs"</span>) <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">!</span><span class="kw">employment_centre_size</span>)

<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="kw">jt_employment_500</span>)
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">area</th>
<th align="left">mode</th>
<th align="left">date</th>
<th align="right">travel_time</th>
<th align="left">unit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">4</td>
<td align="left">Minutes</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">7</td>
<td align="left">Minutes</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">7</td>
<td align="left">Minutes</td>
</tr>
</tbody>
</table>
<p>We can then concatenate this with <code>jt_town</code>. If we do this now, however, there won’t be a way to distinguish between the rows that come from each dataset. The destination of the service being travelled to is defined only in metadata (i.e. by the dataset’s title) and isn’t available in the data to let the observations distinguish themselves <a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. We need to add this column in ourselves:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">jt_town</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">jt_town</span>,
                  destination=<span class="st">"Town Centre"</span>)
<span class="kw">jt_employment_500</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">jt_employment_500</span>,
                            destination=<span class="st">"Employment Centre (500-4999 jobs)"</span>)

<span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_bind.html">vec_rbind</a></span>(<span class="kw">jt_town</span>, <span class="kw">jt_employment_500</span>) <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">area</th>
<th align="left">mode</th>
<th align="left">date</th>
<th align="right">travel_time</th>
<th align="left">unit</th>
<th align="left">destination</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">22.72201</td>
<td align="left">Minutes</td>
<td align="left">Town Centre</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">13.94595</td>
<td align="left">Minutes</td>
<td align="left">Town Centre</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">14.58818</td>
<td align="left">Minutes</td>
<td align="left">Town Centre</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">4.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre (500-4999 jobs)</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">7.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre (500-4999 jobs)</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">7.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre (500-4999 jobs)</td>
</tr>
</tbody>
</table>
<p>Alternatively we can add the column to <code>jt_town</code>. Indeed <code><a href="https://vctrs.r-lib.org/reference/vec_bind.html">vctrs::vec_rbind()</a></code> will automatically set this to <code>NA</code> for us:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">jt_employment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">jt_employment</span>, destination=<span class="st">"Employment Centre"</span>)

<span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_bind.html">vec_rbind</a></span>(<span class="kw">jt_town</span>, <span class="kw">jt_employment</span>) <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()
</pre></div>
<table class="table">
<colgroup>
<col width="9%">
<col width="7%">
<col width="4%">
<col width="11%">
<col width="7%">
<col width="17%">
<col width="39%">
</colgroup>
<thead><tr class="header">
<th align="left">area</th>
<th align="left">mode</th>
<th align="left">date</th>
<th align="right">travel_time</th>
<th align="left">unit</th>
<th align="left">destination</th>
<th align="left">employment_centre_size</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">22.72201</td>
<td align="left">Minutes</td>
<td align="left">Town Centre</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">13.94595</td>
<td align="left">Minutes</td>
<td align="left">Town Centre</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">14.58818</td>
<td align="left">Minutes</td>
<td align="left">Town Centre</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">20.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre</td>
<td align="left">Employment centre with 100 to 499 jobs</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">12.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre</td>
<td align="left">Employment centre with 100 to 499 jobs</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">13.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre</td>
<td align="left">Employment centre with 100 to 499 jobs</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">PT/walk</td>
<td align="left">2017</td>
<td align="right">4.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre</td>
<td align="left">Employment centre with 500 to 4999 jobs</td>
</tr>
<tr class="even">
<td align="left">E01000001</td>
<td align="left">Cycle</td>
<td align="left">2017</td>
<td align="right">7.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre</td>
<td align="left">Employment centre with 500 to 4999 jobs</td>
</tr>
<tr class="odd">
<td align="left">E01000001</td>
<td align="left">Car</td>
<td align="left">2017</td>
<td align="right">7.00000</td>
<td align="left">Minutes</td>
<td align="left">Employment Centre</td>
<td align="left">Employment centre with 500 to 4999 jobs</td>
</tr>
</tbody>
</table>
<hr>
<div style="background-color: #fcf8e3; border-color: #faebcc; padding: 15px; border: 1px solid transparent; border-radius: 4px;">
<h2 style="color: rgb(138, 109, 59); text-align: center;">
The following sections are a work in progress
</h2>
</div>
<hr>
</div>
</div>
<div id="using-correspondence-lookups" class="section level1">
<h1 class="hasAnchor">
<a href="#using-correspondence-lookups" class="anchor"></a>Using correspondence lookups</h1>
<p>The components ought to have compatible values too. We can mix codes from different codelists (<code>skos:Concept</code> URIs from different <code>skos:ConceptScheme</code>s) in the same column, but it is generally nicer to work with a common set.</p>
<p>This is particularly true if the scope of the codelists overlaps. If you can derive a single codelist with a set of mutually exclusive and comprehensively exhaustive codes, then it’s possible to aggregate the values without double-counting or gaps.</p>
<p>We can use correspondence tables to lookup equivalent values from one codelist in another.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="co"># example with correspondence table</span>
<span class="co"># Map SITC to CPA at highest level?</span>
</pre></div>
</div>
<div id="join-cubes-by-dimension-and-code-uris" class="section level1">
<h1 class="hasAnchor">
<a href="#join-cubes-by-dimension-and-code-uris" class="anchor"></a>Join cubes by dimension and code URIs</h1>
<p>If two cubes use the same codelist (or have dimensions with common patterns for URIs like intervals or geographies) then it’s possible to join them on that basis.</p>
<p>If every dimension is common to both cube codes (or if it only a single value), then it’s possible to do a full join using all the dimensions. This will result in a combined cube with the same set of dimensions (which uniquely identify the rows) and two values - one from each of the original cubes.</p>
<p>If these values are distinguished by dimension values, then they will be on different rows. Otherwise, the values could be put into different columns on the same rows. It’s possible to transform the data between these two representations using the <code>tidyr</code> package as described in the <a href="tabulate-datacube.html">Tabulating DataCubes</a> vignette. The longer (row bound) form is nicer for analysis (e.g. modelling or charting) whereas the wider (column bound) form is nicer for calculations that compare the values (e.g. denomination).</p>
<p>We’ll use two tables from Eurostat for this example. The first describes the total number of people employed in each country (in thousands):</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">employment</span>,<span class="fl">3</span>))
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">country</th>
<th align="right">employment</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Austria</td>
<td align="right">4148</td>
</tr>
<tr class="even">
<td align="left">Belgium</td>
<td align="right">4708</td>
</tr>
<tr class="odd">
<td align="left">Bulgaria</td>
<td align="right">3121</td>
</tr>
</tbody>
</table>
<p>The second describes the economically active population of each country (in thousands):</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">population</span>,<span class="fl">3</span>))
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">country</th>
<th align="right">population</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Austria</td>
<td align="right">4336</td>
</tr>
<tr class="even">
<td align="left">Belgium</td>
<td align="right">4969</td>
</tr>
<tr class="odd">
<td align="left">Bulgaria</td>
<td align="right">3258</td>
</tr>
</tbody>
</table>
<p>Both have a <code>country</code> dimension that uses the same codes. We can use them together to calculate the employment rate.</p>
<p>If we combine them by column-binding we create a single, wider table <a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">emp_pop_wide</span> <span class="op">&lt;-</span> <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span>(<span class="kw">employment</span>, <span class="kw">population</span>, by=<span class="st">"country"</span>)

<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">emp_pop_wide</span>))
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">country</th>
<th align="right">employment</th>
<th align="right">population</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Austria</td>
<td align="right">4148</td>
<td align="right">4336</td>
</tr>
<tr class="even">
<td align="left">Belgium</td>
<td align="right">4708</td>
<td align="right">4969</td>
</tr>
<tr class="odd">
<td align="left">Bulgaria</td>
<td align="right">3121</td>
<td align="right">3258</td>
</tr>
<tr class="even">
<td align="left">Switzerland</td>
<td align="right">4321</td>
<td align="right">4515</td>
</tr>
<tr class="odd">
<td align="left">Cyprus</td>
<td align="right">400</td>
<td align="right">431</td>
</tr>
<tr class="even">
<td align="left">Czechia</td>
<td align="right">5126</td>
<td align="right">5230</td>
</tr>
</tbody>
</table>
<p>This form is convenient where we want to address the two variables with metadata.</p>
<p>For example, we can calculate the employment rate by referring to each variable:</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="kw">emp_pop_wide</span> <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(employment_rate = <span class="kw">employment</span> <span class="op">/</span> <span class="kw">population</span>) <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="op">-</span><span class="kw">employment_rate</span>) <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span>(n=<span class="fl">5</span>) <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">country</th>
<th align="right">employment</th>
<th align="right">population</th>
<th align="right">employment_rate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Czechia</td>
<td align="right">5126</td>
<td align="right">5230</td>
<td align="right">0.9801147</td>
</tr>
<tr class="even">
<td align="left">Netherlands</td>
<td align="right">8077</td>
<td align="right">8328</td>
<td align="right">0.9698607</td>
</tr>
<tr class="odd">
<td align="left">Germany (until 1990 former territory of the FRG)</td>
<td align="right">39955</td>
<td align="right">41234</td>
<td align="right">0.9689819</td>
</tr>
<tr class="even">
<td align="left">Malta</td>
<td align="right">245</td>
<td align="right">253</td>
<td align="right">0.9683794</td>
</tr>
<tr class="odd">
<td align="left">Iceland</td>
<td align="right">180</td>
<td align="right">186</td>
<td align="right">0.9677419</td>
</tr>
</tbody>
</table>
<p>Alternatively, we can row-bind the tables to form a single, longer table. We have to add another dimension - <code>variable</code> - to the table to distinguish the rows from each source. This allows us to combine the <code>employment</code> and <code>population</code> measures into a single measure which simply counts <code>people</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="kw">emp_pop_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(<span class="kw">employment</span>, <span class="kw">country</span>, indicator=<span class="st">"Employment"</span>, people=<span class="kw">employment</span>),
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(<span class="kw">population</span>, <span class="kw">country</span>, indicator=<span class="st">"Population"</span>, people=<span class="kw">population</span>)
   )

<span class="kw">emp_pop_long</span> <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="kw">country</span>) <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span>(n=<span class="fl">10</span>) <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()
</pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">country</th>
<th align="left">indicator</th>
<th align="right">people</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Austria</td>
<td align="left">Employment</td>
<td align="right">4148</td>
</tr>
<tr class="even">
<td align="left">Austria</td>
<td align="left">Population</td>
<td align="right">4336</td>
</tr>
<tr class="odd">
<td align="left">Belgium</td>
<td align="left">Employment</td>
<td align="right">4708</td>
</tr>
<tr class="even">
<td align="left">Belgium</td>
<td align="left">Population</td>
<td align="right">4969</td>
</tr>
<tr class="odd">
<td align="left">Bulgaria</td>
<td align="left">Employment</td>
<td align="right">3121</td>
</tr>
<tr class="even">
<td align="left">Bulgaria</td>
<td align="left">Population</td>
<td align="right">3258</td>
</tr>
<tr class="odd">
<td align="left">Switzerland</td>
<td align="left">Employment</td>
<td align="right">4321</td>
</tr>
<tr class="even">
<td align="left">Switzerland</td>
<td align="left">Population</td>
<td align="right">4515</td>
</tr>
<tr class="odd">
<td align="left">Cyprus</td>
<td align="left">Employment</td>
<td align="right">400</td>
</tr>
<tr class="even">
<td align="left">Cyprus</td>
<td align="left">Population</td>
<td align="right">431</td>
</tr>
</tbody>
</table>
<p>This form is convenient where we want to address the two variables as data.</p>
<p>For example, we can plot employment against population:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">emp_pop_long</span>, <span class="op">!</span><span class="kw">country</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"EU27_2020"</span>,<span class="st">"EU28"</span>,<span class="st">"EU15"</span>,<span class="st">"EA19"</span>)),
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="fu"><a href="../reference/label.html">label</a></span>(<span class="kw">country</span>), <span class="kw">people</span>, fill=<span class="kw">indicator</span>)) <span class="op">+</span> 
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span>(position=<span class="st">"dodge"</span>) <span class="op">+</span> 
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span>() <span class="op">+</span> 
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>() <span class="op">+</span> 
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>() <span class="op">+</span>
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(title=<span class="st">"Demographics of European Countries"</span>,
        x=<span class="st">"Country"</span>,
        y=<span class="st">"Count of People (Thousands)"</span>,
        fill=<span class="st">"Indicator"</span>)
</pre></div>
<p><img src="merging-datacubes_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>We’re not really “ignoring” the breakdown, so much as marginalising it by taking a value which effectively represents the integral over that dimension. In the case of counts, for example, this will be a sum. Picking an arbitrary value from the dimension would conditionalise the distribution upon it. Either way we’re removing a dimension from the cube.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Of course the observation URIs would still be distinct, but we didn’t return those from the query so they aren’t in the table. We could instead have had the query bind a <code>dataset</code> variable for the <code>qb:dataSet</code> property in each case (yielding each dataset’s URI), but doing it explicitly like this is hopefully more instructive.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>We use <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::inner_join()</a></code> instead of <code><a href="https://rdrr.io/r/base/merge.html">base::merge()</a></code> because this will ensure the resource descriptions also get joined (dplyr uses vctrs underneath). Merge will only retain the description of the left-hand data frame so it’s safe to use <code><a href="https://rdrr.io/r/base/merge.html">merge(all=F)</a></code> for inner-joins. For right- or full-joins you’ll need to use dplyr instead of (or rebuild the description yourself with e.g. <code><a href="../reference/merge_description.html">merge_description()</a></code>).<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://infonomics.ltd.uk">Robin Gower</a>, <a href="https://www.swirrl.com"><img src="https://www.swirrl.com/icons/icon-512x512.png" height="24"> Swirrl</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
